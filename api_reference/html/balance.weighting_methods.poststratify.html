<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>balance.weighting_methods.poststratify &#8212; balance  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=fb9458d3" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="balance.weighting_methods.rake" href="balance.weighting_methods.rake.html" />
    <link rel="prev" title="balance.weighting_methods.ipw" href="balance.weighting_methods.ipw.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="balance.weighting_methods.rake.html" title="balance.weighting_methods.rake"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="balance.weighting_methods.ipw.html" title="balance.weighting_methods.ipw"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">balance  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="balance.html" >balance</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="balance.weighting_methods.html" accesskey="U">balance.weighting_methods</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">balance.weighting_methods.poststratify</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="module-balance.weighting_methods.poststratify">
<span id="balance-weighting-methods-poststratify"></span><h1>balance.weighting_methods.poststratify<a class="headerlink" href="#module-balance.weighting_methods.poststratify" title="Link to this heading">¶</a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="balance.weighting_methods.poststratify.poststratify">
<span class="sig-prename descclassname"><span class="pre">balance.weighting_methods.poststratify.</span></span><span class="sig-name descname"><span class="pre">poststratify</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sample_df</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">DataFrame</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sample_weights</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Series</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_df</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">DataFrame</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_weights</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Series</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">variables</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">List</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformations</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'default'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transformations_drop</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">strict_matching</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_trimming_mean_ratio</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">int</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_trimming_percentile</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">float</span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">None</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keep_sum_of_weights</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">bool</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">Dict</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">str</span><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><span class="pre">Series</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="_modules/balance/weighting_methods/poststratify.html#poststratify"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#balance.weighting_methods.poststratify.poststratify" title="Link to this definition">¶</a></dt>
<dd><p>Perform cell-based post-stratification to adjust sample weights so that the sample matches the joint distribution of, one or more, specified variables in the target population.</p>
<p>This method computes one weight per <em>cell</em> - a unique combination of the supplied variables - so that the weighted sample reproduces the cell distribution observed in the target population.
When more than one variable is supplied, the function operates on cells from the joint distribution (as opposed to raking, which operates on the marginals distribution).</p>
<p>Reference: <a class="reference external" href="https://docs.wfp.org/api/documents/WFP-0000121326/download/">https://docs.wfp.org/api/documents/WFP-0000121326/download/</a></p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>sample_df</strong> (<em>pd.DataFrame</em>) – DataFrame representing the sample.</p></li>
<li><p><strong>sample_weights</strong> (<em>pd.Series</em>) – Design weights for the sample.</p></li>
<li><p><strong>target_df</strong> (<em>pd.DataFrame</em>) – DataFrame representing the target population.</p></li>
<li><p><strong>target_weights</strong> (<em>pd.Series</em>) – Design weights for the target.</p></li>
<li><p><strong>variables</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><em>str</em><em>]</em><em>]</em><em>, </em><em>optional</em>) – List of variables to define post-stratification cells. If None, uses the intersection of columns in sample_df and target_df.</p></li>
<li><p><strong>transformations</strong> (<em>str</em><em>, </em><em>optional</em>) – Transformations to apply to data before fitting the model. Default is “default”. See <cite>balance.adjustment.apply_transformations</cite>.</p></li>
<li><p><strong>transformations_drop</strong> (<em>bool</em><em>, </em><em>optional</em>) – If True, drops variables not affected by transformations. Default is True.</p></li>
<li><p><strong>strict_matching</strong> (<em>bool</em><em>, </em><em>optional</em>) – If True, requires all sample cells to be present in the target. If False, cells missing in the target are assigned weight 0 (and a warning is raised). Default is True.</p></li>
<li><p><strong>weight_trimming_mean_ratio</strong> (<em>Union</em><em>[</em><em>float</em><em>, </em><em>int</em><em>, </em><em>None</em><em>]</em><em>, </em><em>optional</em>) – Forwarded to
<a class="reference internal" href="balance.adjustment.html#balance.adjustment.trim_weights" title="balance.adjustment.trim_weights"><code class="xref py py-func docutils literal notranslate"><span class="pre">balance.adjustment.trim_weights()</span></code></a> to clip weights at a multiple of the mean.</p></li>
<li><p><strong>weight_trimming_percentile</strong> (<em>Union</em><em>[</em><em>float</em><em>, </em><em>None</em><em>]</em><em>, </em><em>optional</em>) – Percentile limit(s) for
winsorisation, passed to <a class="reference internal" href="balance.adjustment.html#balance.adjustment.trim_weights" title="balance.adjustment.trim_weights"><code class="xref py py-func docutils literal notranslate"><span class="pre">balance.adjustment.trim_weights()</span></code></a>.</p></li>
<li><p><strong>keep_sum_of_weights</strong> (<em>bool</em><em>, </em><em>optional</em>) – Preserve the sum of weights during trimming before
the final normalisation to the target total. Defaults to True.</p></li>
<li><p><strong>*args</strong> – Additional positional arguments (currently unused).</p></li>
<li><p><strong>**kwargs</strong> – Additional keyword arguments (currently unused).</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>weight (pd.Series): Final weights for the sample, summing to the target’s total weight.
model (dict): Description of the adjustment method used.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>ValueError</strong> – If strict_matching is True and some sample cells are missing in the target.</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>The function expects that every combination of <code class="docutils literal notranslate"><span class="pre">variables</span></code> present
in <code class="docutils literal notranslate"><span class="pre">sample_df</span></code> is also present in <code class="docutils literal notranslate"><span class="pre">target_df</span></code>. Set
<code class="docutils literal notranslate"><span class="pre">strict_matching=False</span></code> to keep rows whose cell is missing in the
target and assign them weight 0.</p></li>
<li><p>When no <code class="docutils literal notranslate"><span class="pre">variables</span></code> are provided, the intersection of columns in
<code class="docutils literal notranslate"><span class="pre">sample_df</span></code> and <code class="docutils literal notranslate"><span class="pre">target_df</span></code> is used. In practice you will
usually provide a small number of categorical variables (often one
or two) describing the post-stratification cells.</p></li>
</ul>
<p class="rubric">Examples</p>
<p>Post-stratifying on a single categorical variable:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">,</span> <span class="s2">&quot;Female&quot;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">target_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">design</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sample_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">target_design</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">target_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights</span> <span class="o">=</span> <span class="n">poststratify</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">sample_df</span><span class="o">=</span><span class="n">sample_df</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">sample_weights</span><span class="o">=</span><span class="n">design</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">target_df</span><span class="o">=</span><span class="n">target_df</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">target_weights</span><span class="o">=</span><span class="n">target_design</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">],</span>
<span class="gp">... </span><span class="p">)[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="go">[1.0, 2.0, 1.0]</span>
</pre></div>
</div>
<p>Post-stratifying on the joint distribution of two variables (the
resulting weights depend on the combination of both columns rather
than their marginals):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sample_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35+&quot;</span><span class="p">,</span> <span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35+&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">target_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span>
<span class="gp">... </span>        <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Female&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">,</span> <span class="s2">&quot;Male&quot;</span><span class="p">],</span>
<span class="gp">... </span>        <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35+&quot;</span><span class="p">,</span> <span class="s2">&quot;18-34&quot;</span><span class="p">,</span> <span class="s2">&quot;35+&quot;</span><span class="p">,</span> <span class="s2">&quot;35+&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="p">}</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">design</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sample_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">target_design</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">target_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights</span> <span class="o">=</span> <span class="n">poststratify</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">sample_df</span><span class="o">=</span><span class="n">sample_df</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">sample_weights</span><span class="o">=</span><span class="n">design</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">target_df</span><span class="o">=</span><span class="n">target_df</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">target_weights</span><span class="o">=</span><span class="n">target_design</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span> <span class="s2">&quot;age_group&quot;</span><span class="p">],</span>
<span class="gp">... </span><span class="p">)[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="go">[2.0, 1.0, 1.0, 2.0]</span>
</pre></div>
</div>
</dd></dl>

</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">balance.weighting_methods.poststratify</a><ul>
<li><a class="reference internal" href="#balance.weighting_methods.poststratify.poststratify"><code class="docutils literal notranslate"><span class="pre">poststratify()</span></code></a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="balance.weighting_methods.ipw.html"
                          title="previous chapter">balance.weighting_methods.ipw</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="balance.weighting_methods.rake.html"
                          title="next chapter">balance.weighting_methods.rake</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/balance.weighting_methods.poststratify.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="balance.weighting_methods.rake.html" title="balance.weighting_methods.rake"
             >next</a> |</li>
        <li class="right" >
          <a href="balance.weighting_methods.ipw.html" title="balance.weighting_methods.ipw"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">balance  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="balance.html" >balance</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="balance.weighting_methods.html" >balance.weighting_methods</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">balance.weighting_methods.poststratify</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>