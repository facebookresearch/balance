"use strict";(globalThis.webpackChunkstaticdocs_starter=globalThis.webpackChunkstaticdocs_starter||[]).push([[919],{15680(e,t,n){n.r(t),n.d(t,{MDXContext:()=>l,MDXProvider:()=>u,mdx:()=>h,useMDXComponents:()=>p,withMDXComponents:()=>m});var a=n(96540);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(){return s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},s.apply(this,arguments)}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach(function(t){i(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function d(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),m=function(e){return function(t){var n=p(t.components);return a.createElement(e,s({},t,{components:n}))}},p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef(function(e,t){var n=e.components,i=e.mdxType,s=e.originalType,o=e.parentName,l=d(e,["components","mdxType","originalType","parentName"]),m=p(n),u=i,g=m["".concat(o,".").concat(u)]||m[u]||c[u]||s;return n?a.createElement(g,r(r({ref:t},l),{},{components:n})):a.createElement(g,r({ref:t},l))});function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var s=n.length,o=new Array(s);o[0]=g;var r={};for(var d in t)hasOwnProperty.call(t,d)&&(r[d]=t[d]);r.originalType=e,r.mdxType="string"==typeof e?e:i,o[1]=r;for(var l=2;l<s;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},25404(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_09_seaborn_outcome_kde_after-26fa9668164349253b2614335961ade9.png"},26348(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_05_barplot_age_after-2ca299aaf9256d47fcd1d5b7cb771f03.png"},52345(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_06_barplot_gender_after-a7f7770c95b6491c10db328d5932d87a.png"},58720(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_08_weights_kde-e77811f8a4358f4e63395e304cd46304.png"},69720(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_04_qqplot_income_after-f7333aae22d068c3122561dd1755681f.png"},95256(e,t,n){n.d(t,{A:()=>a});const a=n.p+"assets/images/fig_07_seaborn_after-ac7514f6b150f431b36329bb9ebd9d0a.png"},95811(e,t,n){n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>l});var a=n(58168),i=(n(96540),n(15680));const s={id:"evaluation_of_results",title:"Evaluating and using the adjustment weights",description:"Diagnosing, evaluating, and using the weighted adjusted sample",sidebar_position:3,keywords:["diagnostics","evaluation","results"]},o=void 0,r={unversionedId:"docs/general_framework/evaluation_of_results",id:"docs/general_framework/evaluation_of_results",title:"Evaluating and using the adjustment weights",description:"Diagnosing, evaluating, and using the weighted adjusted sample",source:"@site/docs/docs/general_framework/evaluation_of_results.md",sourceDirName:"docs/general_framework",slug:"/docs/general_framework/evaluation_of_results",permalink:"/docs/docs/general_framework/evaluation_of_results",draft:!1,editUrl:"https://github.com/facebookresearch/balance/tree/main/website/docs/docs/general_framework/evaluation_of_results.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"evaluation_of_results",title:"Evaluating and using the adjustment weights",description:"Diagnosing, evaluating, and using the weighted adjusted sample",sidebar_position:3,keywords:["diagnostics","evaluation","results"]},sidebar:"docsSidebar",previous:{title:"Adjusting Sample to Population",permalink:"/docs/docs/general_framework/adjusting_sample_to_population"},next:{title:"Statistical Methods",permalink:"/docs/docs/statistical_methods/"}},d={},l=[{value:"Summary statistics",id:"summary-statistics",level:2},{value:"Summary",id:"summary",level:3},{value:"Covariate Balance",id:"covariate-balance",level:2},{value:"Understanding the model",id:"understanding-the-model",level:2},{value:"Visualization post adjustments",id:"visualization-post-adjustments",level:2},{value:"Distribution of Weights",id:"distribution-of-weights",level:2},{value:"Analyzing the outcome",id:"analyzing-the-outcome",level:2},{value:"Impact of weights on outcomes",id:"impact-of-weights-on-outcomes",level:3}],m={toc:l};function p({components:e,...t}){return(0,i.mdx)("wrapper",(0,a.A)({},m,t,{components:e,mdxType:"MDXLayout"}),(0,i.mdx)("p",null,"After weights are fitted in order to balance the sample, the results should be evaluated so to understand the quality of the weighting."),(0,i.mdx)("h2",{id:"summary-statistics"},"Summary statistics"),(0,i.mdx)("h3",{id:"summary"},"Summary"),(0,i.mdx)("p",null,"Printing the adjusted object gives a high level overview of the content of the object:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"print(adjusted)\n")),(0,i.mdx)("p",null,"Output:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"\n        Adjusted balance Sample object with target set using ipw\n        1000 observations x 3 variables: gender,age_group,income\n        id_column: id, weight_column: weight,\n        outcome_columns: happiness\n\n        adjustment details:\n            method: ipw\n            weight trimming mean ratio: 20\n            design effect (Deff): 1.880\n            effective sample size proportion (ESSP): 0.532\n            effective sample size (ESS): 531.9\n\n            target:\n\n            balance Sample object\n            10000 observations x 3 variables: gender,age_group,income\n            id_column: id, weight_column: weight,\n            outcome_columns: happiness\n\n            3 common variables: gender,age_group,income\n\n")),(0,i.mdx)("p",null,"To generate a summary of the data, use the summary method:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"print(adjusted.summary())\n")),(0,i.mdx)("p",null,"This will return several results:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"Adjustment details: method used and weight trimming parameters"),(0,i.mdx)("li",{parentName:"ul"},'Covariate diagnostics: ASMD is "Absolute Standardized Mean Difference". For continuous variables, this measure is the same as taking the absolute value of ',(0,i.mdx)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Effect_size#Cohen's_d"},"Cohen's d statistic")," (also related to ",(0,i.mdx)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Strictly_standardized_mean_difference"},"SSMD"),"), when using the (weighted) standard deviation of the target population. For categorical variables it uses ",(0,i.mdx)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/One-hot"},"one-hot encoding"),". Also includes KLD (Kullback-Leibler divergence) metrics."),(0,i.mdx)("li",{parentName:"ul"},"Weight diagnostics: ",(0,i.mdx)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Design_effect"},"Design effect"),", effective sample size proportion (ESSP), and effective sample size (ESS)"),(0,i.mdx)("li",{parentName:"ul"},"Outcome weighted means: means for each outcome variable across self (adjusted), target, and unadjusted samples"),(0,i.mdx)("li",{parentName:"ul"},"Model performance: Model proportion deviance explained (if inverse propensity weighting method was used)")),(0,i.mdx)("p",null,"Output:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"Adjustment details:\n    method: ipw\n    weight trimming mean ratio: 20\nCovariate diagnostics:\n    Covar ASMD reduction: 63.4%\n    Covar ASMD (7 variables): 0.327 -> 0.120\n    Covar mean KLD reduction: 95.3%\n    Covar mean KLD (3 variables): 0.071 -> 0.003\nWeight diagnostics:\n    design effect (Deff): 1.880\n    effective sample size proportion (ESSP): 0.532\n    effective sample size (ESS): 531.9\nOutcome weighted means:\n            happiness\nsource\nself           53.295\ntarget         56.278\nunadjusted     48.559\nModel performance: Model proportion deviance explained: 0.173\n")),(0,i.mdx)("p",null,"Note that although we had 3 variables in our original data (age_group, gender, income), the asmd counts each level of the categorical variables as separate variable, and thus it considered 7 variables for the covar ASMD improvement."),(0,i.mdx)("h2",{id:"covariate-balance"},"Covariate Balance"),(0,i.mdx)("p",null,"We can check the mean of each variable before and after applying the weights using ",(0,i.mdx)("inlineCode",{parentName:"p"},".mean()"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.covars().mean().T\n")),(0,i.mdx)("p",null,"To get:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"source                      self     target  unadjusted\n_is_na_gender[T.True]   0.086776   0.089800    0.088000\nage_group[T.25-34]      0.307355   0.297400    0.300000\nage_group[T.35-44]      0.273609   0.299200    0.156000\nage_group[T.45+]        0.137581   0.206300    0.053000\ngender[Female]          0.406337   0.455100    0.268000\ngender[Male]            0.506887   0.455100    0.644000\ngender[_NA]             0.086776   0.089800    0.088000\nincome                 10.060068  12.737608    6.297302\n")),(0,i.mdx)("p",null,"Here, ",(0,i.mdx)("inlineCode",{parentName:"p"},"self")," is the adjusted (weighted) covariate mean, ",(0,i.mdx)("inlineCode",{parentName:"p"},"target")," is the target mean, and ",(0,i.mdx)("inlineCode",{parentName:"p"},"unadjusted")," is the unadjusted sample mean."),(0,i.mdx)("p",null,"And ",(0,i.mdx)("inlineCode",{parentName:"p"},".asmd()")," to get ASMD:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.covars().asmd().T\n")),(0,i.mdx)("p",null,"To get:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"source                  self  unadjusted  unadjusted - self\nage_group[T.25-34]  0.021777    0.005688          -0.016090\nage_group[T.35-44]  0.055884    0.312711           0.256827\nage_group[T.45+]    0.169816    0.378828           0.209013\ngender[Female]      0.097916    0.375699           0.277783\ngender[Male]        0.103989    0.379314           0.275324\ngender[_NA]         0.010578    0.006296          -0.004282\nincome              0.205469    0.494217           0.288748\nmean(asmd)          0.119597    0.326799           0.207202\n")),(0,i.mdx)("p",null,"We can see that on average the ASMD improved from 0.33 to 0.12 thanks to the weights. We got improvements in income, gender, and age_group.\nAlthough we can see that ",(0,i.mdx)("inlineCode",{parentName:"p"},"age_group[T.25-34]")," and ",(0,i.mdx)("inlineCode",{parentName:"p"},"gender[_NA]")," didn't improve."),(0,i.mdx)("h2",{id:"understanding-the-model"},"Understanding the model"),(0,i.mdx)("p",null,"For a summary of the diagnostics measures, use:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.diagnostics()\n")),(0,i.mdx)("p",null,"This will give a long table that can be filterred to focus on various diagnostics metrics. For example, when the ",(0,i.mdx)("inlineCode",{parentName:"p"},".adjust()")," method is run with ",(0,i.mdx)("inlineCode",{parentName:"p"},'model="ipw"')," (the default method), then the rows from the diagnostics output with ",(0,i.mdx)("inlineCode",{parentName:"p"},'metric == "model_coef"')," represent the coefficients of the variables in the model. These can be used to understand the model that was fitted (after transformations and regularization)."),(0,i.mdx)("h2",{id:"visualization-post-adjustments"},"Visualization post adjustments"),(0,i.mdx)("p",null,"We can create all (interactive) plots using:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.covars().plot()\n")),(0,i.mdx)("p",null,"And get:"),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(69720).A,width:"1803",height:"450"})),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(26348).A,width:"1803",height:"450"})),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(52345).A,width:"1803",height:"450"})),(0,i.mdx)("p",null,'We can also use different plots, using the seaborn library, for example with the "kde" dist_type.'),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},'adjusted.covars().plot(library = "seaborn", dist_type = "kde")\n')),(0,i.mdx)("p",null,"And get:"),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(95256).A,width:"448",height:"1204"})),(0,i.mdx)("h2",{id:"distribution-of-weights"},"Distribution of Weights"),(0,i.mdx)("p",null,"We can look at the distribution of weights using the following method call:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.weights().plot()\n")),(0,i.mdx)("p",null,"And get:"),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(58720).A,width:"445",height:"443"})),(0,i.mdx)("p",null,"Or calculate the design effect using:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.weights().design_effect()\n# 1.88\n")),(0,i.mdx)("h2",{id:"analyzing-the-outcome"},"Analyzing the outcome"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},".summary()")," method gives us the response rates (if we have missing values in the outcome), and the weighted means before and after applying the weights:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"print(adjusted.outcomes().summary())\n")),(0,i.mdx)("p",null,"To get:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"1 outcomes: ['happiness']\nMean outcomes (with 95% confidence intervals):\nsource       self  target  unadjusted           self_ci         target_ci     unadjusted_ci\nhappiness  53.295  56.278      48.559  (52.096, 54.495)  (55.961, 56.595)  (47.669, 49.449)\n")),(0,i.mdx)("p",null,"Note: The ",(0,i.mdx)("inlineCode",{parentName:"p"},"target")," column and target-based response rates appear only when the target ",(0,i.mdx)("inlineCode",{parentName:"p"},"Sample")," has outcome data. If your target has no outcomes, you will only see ",(0,i.mdx)("inlineCode",{parentName:"p"},"self")," and ",(0,i.mdx)("inlineCode",{parentName:"p"},"unadjusted")," columns."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"\nWeights impact on outcomes (t_test):\n           mean_yw0  mean_yw1  mean_diff  diff_ci_lower  diff_ci_upper  t_stat  p_value       n\noutcome\nhappiness    48.559    53.295      4.736          1.312          8.161   2.714    0.007  1000.0\n\nResponse rates (relative to number of respondents in sample):\n   happiness\nn     1000.0\n%      100.0\nResponse rates (relative to notnull rows in the target):\n    happiness\nn     1000.0\n%       10.0\nResponse rates (in the target):\n    happiness\nn    10000.0\n%      100.0\n\n")),(0,i.mdx)("p",null,"For example, we see that the estimated mean happiness according to our sample is 48.6 without any adjustment and 53.3 with adjustment (compared to the target mean of 56.3). The following shows the distribution of happiness before and after applying the weights:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"adjusted.outcomes().plot()\n")),(0,i.mdx)("h3",{id:"impact-of-weights-on-outcomes"},"Impact of weights on outcomes"),(0,i.mdx)("p",null,"To assess whether weighting statistically shifts the outcomes, compare the paired\nproducts ",(0,i.mdx)("inlineCode",{parentName:"p"},"y*w0")," versus ",(0,i.mdx)("inlineCode",{parentName:"p"},"y*w1"),". The helper below uses a paired t-test and reports\nthe baseline means, the mean difference, and its confidence interval:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},'adjusted.outcomes().weights_impact_on_outcome_ss(method="t_test")\n')),(0,i.mdx)("p",null,"You can also include this in the printable summary (enabled by default):"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"print(adjusted.outcomes().summary())\n")),(0,i.mdx)("p",null,"In diagnostics output, these appear under ",(0,i.mdx)("inlineCode",{parentName:"p"},"weights_impact_on_outcome_*")," metrics\nby default (set ",(0,i.mdx)("inlineCode",{parentName:"p"},"weights_impact_method=None")," to disable in the summary, or\npass ",(0,i.mdx)("inlineCode",{parentName:"p"},"weights_impact_on_outcome_method=None")," when calling diagnostics)."),(0,i.mdx)("p",null,"To compare two adjusted models (for example, IPW vs. CBPS) on the same outcomes,\nuse:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-python"},"from balance.stats_and_plots.impact_of_weights_on_outcome import (\n    compare_adjusted_weighted_outcome_ss,\n)\n\ncompare_adjusted_weighted_outcome_ss(adjusted_ipw, adjusted_cbps)\n")),(0,i.mdx)("p",null,"And we get:"),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:n(25404).A,width:"450",height:"443"})))}p.isMDXComponent=!0}}]);